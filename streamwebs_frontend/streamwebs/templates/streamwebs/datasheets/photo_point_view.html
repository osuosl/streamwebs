{% extends 'streamwebs/base.html' %}
{% load staticfiles %}
{% load i18n %}
{% load filters %}
{% block content %}
  <a href="{% url 'streamwebs:camera_point' site.site_slug cp.id %}" id="back"
      class="wave-effects wave-light btn white-text teal darken-3">
    <i class="material-icons">chevron_left</i>
    Back to <span>{{ site.site_name }} {% trans "Camera Point" %}</span>
  </a>
  <br/>
  <br/>
  <div class="container">
    {% if messages %}
      <div class="center-content">
        {% for message in messages %}
          <strong>{{ message }}</strong>
        {% endfor %}
      </div>
    {% endif %}
    <!-- PP info -->
    <div>
      <h4 class="center teal-text">
        {{ pp.camera_point.site.site_name }}:
        camera point {{ pp.camera_point.letter }}
      </h4>
      <br/><br/>
      <div class="row">
        <div class="col s6">
          <p>
            <b>{% trans "Date established" %}:</b>
            {{ pp.pp_date|date:"m-d-Y" }}
          </p>
        </div>
        <div class="col s6">
          <p>
            <b>{% trans "Compass bearing" %}:</b>
            {{ pp.compass_bearing }} Â°
          </p>
        </div>
      </div>
      <div class="row">
        <div class="col s6">
          <p>
            <b>{% trans "Distance from camera point" %} {{ pp.camera_point.letter }}: </b>
            {% if pp.distance %}
              {{ pp.distance }} ft
            {% endif %}
          </p>
        </div>
        <div class="col s6">
          <p>
            <b>{% trans "Camera height" %}:</b>
            {% if pp.camera_height %}
              {{ pp.camera_height }} ft
            {% endif %}
          </p>
        </div>
      </div>
      <div class="row">
        <div class="col s6">
          <p>
            <b>{% trans "Notes" %}:</b>
            {% if pp.notes %}
              {{ pp.notes }}
            {% endif %}
          </p>
        </div>
      </div>
      <hr/>
      <!-- New photo upload -->
      <div class="row">
        <div class="col s6 offset-s3">
          {% if user.is_authenticated %}
            {% if messages %}
              {% for msg in messages %}
                {{ msg }}
              {% endfor %}
            {% endif %}
            <h4 class="teal-text">{% trans "Add New Photo" %}</h4>
            <form id='ppi_form' , method='post' , enctype='multipart/form-data'>
              {% csrf_token %}
              {{ ppi_formset.management_form }}
              {% for ppi_form in ppi_formset %}
                <div class="row">
                  <div class="col s12">
                    <div class="input-field">
                      <b>{{ ppi_form.image.label }}</b>
                      <br/>
                      <br/>
                      {{ ppi_form.image }}
                      {{ ppi_form.image.errors }}
                    </div>
                  </div>
                  <div class="col s12">
                    <div class="input-field">
                      <b>{{ ppi_form.date.label }}</b>
                      {{ ppi_form.date }}
                      {{ ppi_form.date.errors }}
                    </div>
                  </div>
                </div>
              {% endfor %}
              <button class="btn waves-effect waves-light teal darken-3"
                      type="submit" name="action" value='Submit'>
                {% trans "Submit" %}
                <i class="material-icons right">send</i>
              </button>
            </form>
          {% else %}
            <a href="{% url 'streamwebs:login' %}?next={{ request.path }}">
              {% trans "Log in to add photos for this photo point." %}
            </a>
          {% endif %}
        </div>
      </div>
      <hr/><br/>
      <h4 class="center teal-text">{% trans "Photos for this photo point" %}</h4>
      <div class="row">
        <div class="col s12 m8 offset-m2">
          {% for img in pp_images %}
            <div class="card">
              <div class="card-image">
                <a href="{{ img.image.url }}" target="_blank">
                  <img src="{{ img.image.url }}" alt="pp image"/>
                </a>
              </div>
              <div class="card-content">
                <p><b>{% trans "Date" %}:</b> {{ img.date|date:"m-d-Y" }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    $(document).ready(function () {
      $('.datepicker').pickadate({
        today: '',
        selectMonths: true, // Creates a dropdown to control month
        selectYears: 100, // Creates a dropdown of 15 years to control year
        max: true, // set max to today
        format: 'yyyy-mm-dd',
      });
    });
    window.onload = function() {
      $('input.datepicker').on('change', function() {
        $(this).removeClass('picker__input--active');
        $(this).attr('aria-expanded', false);
        var picker = $(this).parent().find('div.picker');
        picker.removeClass('picker--focused');
        picker.removeClass('picker--opened');
        picker.attr('aria-hidden', true);
        var dateDiv = $(this).find('div.pidkcer__day');
        $(document.documentElement).css( 'overflow', '' ).
            css( 'padding-right', '-=' + getScrollbarWidth());
      });

      $('input.datepicker').on('click', function() {
        var picker = $(this).parent().find('div.picker');
        picker.addClass('picker--opened');
      });
    }
    // From the Materialize source code
    function getScrollbarWidth() {
      if ( $(document.documentElement).height() <= $(window).height() ) {
          return 0;
      }
      var $outer = $( '<div style="visibility:hidden;width:100px" />' ).
          appendTo( 'body' );
      var widthWithoutScroll = $outer[0].offsetWidth;
      // Force adding scrollbars.
      $outer.css( 'overflow', 'scroll' );
      // Add the inner div.
      var $inner = $( '<div style="width:100%" />' ).appendTo( $outer );
      // Get the width with scrollbars.
      var widthWithScroll = $inner[0].offsetWidth;
      // Remove the divs.
      $outer.remove();
      // Return the difference between the widths.
      return widthWithoutScroll - widthWithScroll;
    }
  </script>
{% endblock %}
